<div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
  <h1 class="text-2xl font-semibold text-gray-900">Shipping</h1>

  <div class="flex">
    <div class="block mx-auto">
      <label for="searchByShipmentNumber" class="hidden">Search</label>
      <div class="relative pt-3 pb-4">
        <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
          <span class="icon is-medium is-left">
            <fa-icon [icon]="faSearch"></fa-icon>
          </span>
        </div>
        <input id="searchByShipmentNumber" class="input-base pl-10 pr-2" [ngClass]="searchShipmentNumber?.length > 0 ? 'rounded-b-none' : ''" placeholder="Search Shipments" autocomplete="off" autocapitalize="words"
               [(ngModel)]="searchShipmentNumber" (keyup)='search()' />
        <div *ngIf="searchResults" class="block absolute bg-gray-100 z-30 w-full">
          <div *ngFor="let result of searchResults" class="flex hover:bg-gray-200 border-gray-200 border-r border-b items-center" (click)="load(result.id)">
            <div class="flex-none m-1 mr-3">
              <app-marketplace-icon [cls]="result?.salesOrder.cls"></app-marketplace-icon>
            </div>

            <div class="m-1 mr-3">
              <p class="font-semibold">{{result.shipmentNumber}}</p>
              <p class="font-light">{{result?.salesOrder.alternateOrderNumber}}</p>
              <p class="font-light">{{result?.departingWarehouse.name}}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="p-4" *ngIf="shipment">
    <div class="block lg:flex lg:flex-row">
      <div class="w-64">
        <p class="data-label">DETAILS</p>
        <div class="flex items-center">
          <app-marketplace-icon [cls]="shipment?.salesOrder.cls"></app-marketplace-icon>
          <div *ngIf="shipment.shipmentNumber" class="ml-4">
            <div *ngIf="shipment.shipmentNumber" class="leading-5 font-medium text-gray-900"><span class="font-light">{{shipment.shipmentNumber.substr(0, 11)}}</span><span class="font-semibold">{{shipment.shipmentNumber.substr(11)}}</span></div>
            <div *ngIf="shipment.salesOrder.alternateOrderNumber" class="text-sm leading-5 font-light text-gray-500">{{shipment.salesOrder.alternateOrderNumber}}</div>
          </div>
        </div>
      </div>

      <div (click)="showShipmentDialog()" class="w-64 click-area">
        <p class="data-label">CONTENTS</p>
        <div *ngFor="let item of shipment.shipmentItems; index as i">
          <p *ngIf="i < 3" class="text-xs leading-5">
            <span class="font-semibold text-gray-900">{{item.quantity}}</span><span class="font-thin">x</span>&nbsp;<span class="font-medium text-gray-900">{{item.salesOrderItem.sku}}</span>:&nbsp;<span class="font-thin text-gray-900">{{item.salesOrderItem.name}}</span>
          </p>
        </div>
        <div *ngIf="shipment.shipmentItems.length > 3">
          <span class="text-sm leading-5 font-medium text-gray-900">and more...</span>
        </div>
      </div>

      <div class="w-64">
        <div>
          <p class="data-label">STATUS</p>
          <app-shipment-status [shipmentStatus]="shipment.shipmentStatus"></app-shipment-status>
        </div>
        <div *ngIf="shipmentSent">
          <p class="data-label">TRACKING</p>
          <span *ngFor="let trackingNo of shipment.trackingNos; index as i">
            {{trackingNo}}<ng-container *ngIf="i + 1 !== shipment.trackingNos.length">, </ng-container>
          </span>
        </div>
      </div>

      <div class="h-6 lg:flex-1"></div>

    </div>
  </div>

  <div class="p-4" *ngIf="shipment">
    <div class="block lg:flex lg:flex-row">
      <div class="w-64">
        <div (click)="showEditAddressDialog()" [ngClass]="{'relative click-area' : shipmentEditable}">
          <p class="data-label">DESTINATION</p>
          <p class="font-light">{{shipment.firstName}} {{shipment.lastName}}</p>
          <p class="font-light" *ngIf="shipment.company">{{shipment.company}}</p>
          <p class="font-light">{{shipment.line1}}</p>
          <p class="font-light" *ngIf="shipment.line2">{{shipment.line2}}</p>
          <p class="font-light">{{shipment.city}}<span *ngIf="shipment.city">, </span>{{shipment.state}}  {{shipment.postalCode}}</p>
          <fa-icon *ngIf="shipmentEditable" class="absolute top-1 right-1 flex" [icon]="faPencil"></fa-icon>
        </div>
        <p *ngIf="!shipment.addressValidationSource || shipment.addressValidationSource === 'Unverified'"><span class="text-gray-500">Address is unverified. </span><button *ngIf="shipmentEditable" class="text-blue-600 hover:text-blue-800" (click)="verifyAddress()">Verify</button></p>
        <p *ngIf="shipment.addressValidationSource && shipment.addressValidationSource !== 'Unverified'"><span class="text-gray-500">Address verified by {{shipment.addressValidationSource}}.</span></p>
      </div>

      <div class="h-6 lg:flex-1"></div>

      <div class="w-64">
        <p class="data-label">SCHEDULE</p>
        <p class="font-light" *ngIf="shipment.placedAt">Placed On: {{shipment.placedAt | date: 'EE, MMM d'}}</p>
        <p class="font-light" *ngIf="shipment.estimatedShipDate">Ship By: {{shipment.estimatedShipDate | date: 'EE, MMM d'}}</p>
        <p class="font-light" *ngIf="shipment.estimatedDeliveryDate">Deliver By: {{shipment.estimatedDeliveryDate | date: 'EE, MMM d'}}</p>
        <p class="font-light" *ngIf="shipment.shippedAt">Shipped On: {{shipment.shippedAt | date: 'EE, MMM d'}}</p>
        <p class="font-light" *ngIf="shipment.shippedBy">Shipped By: {{shipment.shippedBy}}</p>
      </div>

      <div class="h-6 lg:flex-1"></div>

    </div>
  </div>

  <div *ngIf="shipment && shipmentEditable" class="p-4">
    <div *ngFor="let pack of packages; let i = index" class="flex">
      <div class="max-w-full mb-2 relative flex flex-col" (click)="setActivePackage(i)" (keyup)="setActivePackage(i)">
        <p *ngIf="packages.length > 1" class="data-label border-b-2 border-gray-400 mb-2 pb-1 self-start">
          Package {{i + 1}}</p>
        <fa-icon *ngIf="packages.length > 1" class="absolute top-0 flex click-area p-1 -m-1"
                 style="left: -1.5rem" [icon]="faTimesCircle" (click)="removePackage(i)"></fa-icon>
        <div class="flex flex-row gap-2 flex-wrap">
          <div class="w-56">
            <p class="data-label">LENGTH</p>
            <label for="length" class="hidden">Length</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                <fa-icon [icon]="faRulerHorizontal"></fa-icon>
              </span>
              </div>
              <input id="length" type="number" min="0" class="input-base pl-10 pr-7 text-4xl text-right"
                     [placeholder]="shipment.estimatedLength && packages.length === 1 ? (shipment.estimatedLength | number: '0.0-0') : ''"
                     autocomplete="off" autocapitalize="words" (tap)="showLengthDialog()"
                     [(ngModel)]="packages[i].length" />
              <div class="absolute inset-y-0 right-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                IN
              </span>
              </div>
            </div>
          </div>
          <div class="w-56">
            <p class="data-label">WIDTH</p>
            <label for="width" class="hidden">Width</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                <fa-icon [icon]="faRuler"></fa-icon>
              </span>
              </div>
              <input id="width" type="number" min="0" class="input-base pl-10 pr-7 text-4xl text-right"
                     [placeholder]="shipment.estimatedWidth && packages.length === 1 ? (shipment.estimatedWidth | number: '0.0-0') : ''"
                     autocomplete="off" autocapitalize="words" (tap)="showWidthDialog()"
                     [(ngModel)]="packages[i].width" />
              <div class="absolute inset-y-0 right-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                IN
              </span>
              </div>
            </div>
          </div>
          <div class="w-56">
            <p class="data-label">HEIGHT</p>
            <label for="height" class="hidden">Height</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                <fa-icon [icon]="faRulerVertical"></fa-icon>
              </span>
              </div>
              <input id="height" type="number" min="0" class="input-base pl-10 pr-7 text-4xl text-right"
                     [placeholder]="shipment.estimatedHeight && packages.length === 1 ? (shipment.estimatedHeight | number: '0.0-0') : ''"
                     autocomplete="off" autocapitalize="words" (tap)="showHeightDialog()"
                     [(ngModel)]="packages[i].height" />
              <div class="absolute inset-y-0 right-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                IN
              </span>
              </div>
            </div>
          </div>
          <div class="w-56">
            <p class="data-label">WEIGHT</p>
            <label for="weight" class="hidden">Weight</label>
            <div class="relative">
              <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                <fa-icon [icon]="faBalanceScale"></fa-icon>
              </span>
              </div>
              <input id="weight" type="number" min="0" step=".1" class="input-base pl-10 pr-7 text-4xl text-right"
                     [placeholder]="shipment.estimatedWeight && packages.length === 1 ? (shipment.estimatedWeight | number: '0.1-1') : ''"
                     autocomplete="off" autocapitalize="words" (tap)="showWeightDialog()"
                     [(ngModel)]="packages[i].weight" />
              <div class="absolute inset-y-0 right-0 pr-2.5 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                LB
              </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="">
      <div class="w-56">
        <button class="font-bold button button-blue" (click)="addPackage()">
          <fa-icon [icon]="faPlusCircle"></fa-icon>
          Package
        </button>
      </div>
    </div>
  </div>

  <div class="p-4" *ngIf="shipment && shipmentSent">
    <p class="data-label">DIMENSIONS</p>
    <span *ngIf="shipment.actualLength && shipment.actualWidth && shipment.actualHeight">{{shipment.actualLength}} x {{shipment.actualWidth}} x {{shipment.actualHeight}} IN</span>
    <span *ngIf="shipment.trackingNos.length > 1">Multi Package</span>
  </div>

  <div class="p-4" *ngIf="shipment && shipmentSent">
    <p class="data-label">WEIGHT</p>
    <span *ngIf="shipment.actualWeight">{{shipment.actualWeight}} LB</span>
    <span *ngIf="shipment.trackingNos.length > 1">Multi Package</span>
  </div>

  <div class="p-4" *ngIf="shipment && shipmentEditable">
    <div class="block lg:flex lg:flex-row">
      <div class="w-full">
        <p class="data-label">SERVICE</p>
        <div class="relative w-full max-w-lg click-area-offset" [ngClass]="checkMethodRequirements() ? 'click-area' : 'cursor-not-allowed opacity-50'" (click)="showMethodDialog()">
          <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
            <span class="icon is-medium is-left">
              <app-carrier-icon [carrier]="carrier"></app-carrier-icon>
            </span>
          </div>
          <div class="input-base h-20 pl-15 pr-3">
            <p class="text-2xl" [ngClass]="{'pt-3': !(options && options.length > 0)}">
              <span *ngIf='(carrier && service)' class="font-light text-gray-600">{{carrier | carrier}}</span> {{service | service}}
              <span *ngIf='!(carrier && service)' class="font-light text-gray-600">Not Specified</span>
            </p>
            <p class="font-light">
              <span *ngFor="let option of options">
                {{ option | option }}&nbsp;
              </span>
            </p>
          </div>
          <div class="absolute inset-y-0 right-0 pr-3 pl-3 flex items-center pointer-events-none">
            <span class="icon is-medium is-left">
              <span *ngIf="checkMethodRequirements()" class="icon is-medium is-left"><fa-icon [icon]="faPencil"></fa-icon></span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="p-4" *ngIf="shipment && shipmentSent">
    <div class="block lg:flex lg:flex-row">
      <div class="w-full">
        <p class="data-label">SERVICE</p>
        <div class="relative w-full max-w-lg">
          <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                <app-carrier-icon [carrier]="shipment.carrier"></app-carrier-icon>
              </span>
          </div>
          <div class="input-base h-20 pl-15 pr-3 cursor-default">
            <p class="text-2xl" [ngClass]="{'pt-3':!(options && options.length > 0)}">
              <span class="font-light text-gray-600">{{shipment.carrier | carrier}}</span> {{shipment.service | service}}
            </p>
            <p class="font-light">
              <span *ngFor="let option of shipment.options">
                {{ option | option }}&nbsp;
              </span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="p-4" *ngIf="shipment && shipmentEditable">
    <div class="block lg:flex lg:flex-row lg:gap-2 max-w-screen-md">
      <div class="w-full max-w-lg">
        <p class="data-label">PACKAGING</p>
        <div class="relative w-full max-w-lg click-area-offset" [ngClass]="packages.length === 1 ? 'click-area' : 'cursor-not-allowed opacity-50'" (click)="showPackagingDialog()">
          <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
            <span class="icon is-medium is-left">
              <app-packaging-icon [packaging]="packaging"></app-packaging-icon>
            </span>
          </div>
          <div class="input-base pl-15 pr-3 text-4xl">
            <span *ngIf='packaging' class="font-light text-gray-600">{{packaging | packaging}}</span>
            <span *ngIf='!packaging' class="font-light text-gray-600">Not Specified</span>
          </div>
          <div class="absolute inset-y-0 right-0 pr-3 pl-3 flex items-center pointer-events-none">
            <span class="icon is-medium is-left">
              <span *ngIf="packages.length === 1" class="icon is-medium is-left"><fa-icon [icon]="faPencil"></fa-icon></span>
            </span>
          </div>
        </div>
      </div>

      <div class="w-64">
        <button class="w-full h-16 font-bold mt-5 button button-green"
                [disabled]="!checkShippingRequirements()"
                (click)="shipShipment()">
          Ship
        </button>
      </div>
    </div>
  </div>

  <div class="p-4" *ngIf="shipment && shipmentSent">
    <div class="block lg:flex lg:flex-row">
      <div class="w-full">
        <p class="data-label">PACKAGING</p>
        <div class="relative w-full max-w-lg">
          <div class="absolute inset-y-0 left-0 pr-3 pl-3 flex items-center pointer-events-none">
              <span class="icon is-medium is-left">
                <app-packaging-icon [packaging]="shipment.packaging"></app-packaging-icon>
              </span>
          </div>
          <div class="input-base pl-15 pr-3 text-4xl cursor-default">
            <span class="font-light text-gray-600">{{shipment.packaging | packaging}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="p-4 lg:flex" *ngIf="shipment && shipment.shipmentStatus === 'Shipped'">
    <div class="w-64">
      <button class="w-full font-bold button button-red" (click)="voidShipment()">
        Void Shipment
      </button>
    </div>

    <div class="w-64 lg:ml-64">
      <button class="w-full mt-2 lg:mt-0 font-bold button button-green" (click)="reprintLabel()">
        Reprint Label
      </button>
    </div>
  </div>
</div>
